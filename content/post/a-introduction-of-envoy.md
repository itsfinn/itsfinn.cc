---
title: "Envoy 介绍"
date: 2023-12-11T12:00:00+08:00
isCJKLanguage: true
Description: "Envoy 官网介绍文档的中文翻译"
Tags: ["envoy", "introduction", "介绍"]
Categories: ["envoy"]
DisableComments: false
---


Envoy 官网介绍文档的中文翻译, 原文地址: https://www.envoyproxy.io/docs/envoy/v1.28.0/intro/intro
<!--more-->

# 什么是 Envoy

Envoy 是一个 L7 代理和通信总线，专为大型现代面向服务的架构而设计。 该项目的诞生源于以下理念：

> 网络应该对应用程序透明。当网络和应用程序出现问题时 应该很容易确定问题的根源。

在实践中，实现上述目标是非常困难的。Envoy 试图通过提供以下高级功能达成上述目标：

**进程外架构：** Envoy 是一个独立的进程，旨在与每个应用程序服务一起运行。
所有 Envoy 形成一个透明的通信网格，其中每个应用程序都向 localhost 发送和接收消息，
并且不感知网络拓扑。与传统的服务间通信库方法相比，进程外架构具有两个显著优势：

* Envoy 可以与任何应用程序语言一起使用。单个 Envoy 部署可以在 Java、C++、Go、
PHP、Python 等之间形成网格。在面向服务的架构中, 经常会使用多种应用程序框架和语言,
这正变得越来越普遍。Envoy 透明地弥合了这之间的差距。

* 任何使用过大型面向服务架构的人都知道，部署库升级可能是非常痛苦的。
Envoy 可以在整个基础架构上, 快速透明地部署和升级。

**L3/L4 过滤器架构：** 从本质上讲，Envoy 是一个 L3/L4 网络代理。envoy 设计了
可插拔的 filter 链机制, 这允许我们编写过滤器, 并把它插入到 main server 中, 
来执行不同的 TCP/UDP 代理任务, envoy 本身已经提供了一些过滤器来支持各种任务，
例如 TCP proxy, UDP proxy, HTTP proxy, TLS client certificate authentication, 
Redis, MongoDB, Postgres 等。

**HTTP L7 过滤器架构：** HTTP 是现代应用程序架构中如此重要的组成部分，
以至于 Envoy 支持 一个额外的 HTTP L7 过滤器层。HTTP 过滤器可以插入到 
HTTP 连接管理子系统中，这些过滤器执行不同任务的, 例如缓冲、限流、路由/转发、
嗅探 Amazon 的 DynamoDB 等。

**一流的 HTTP/2 支持：** 在 HTTP 模式下运行时，Envoy 支持 HTTP/1.1 和 HTTP/2。
Envoy 可以作为双向透明的 HTTP/1.1 到 HTTP/2 代理运行。这意味着可以桥接任何组合
的 HTTP/1.1 和 HTTP/2 客户端和目标服务器。推荐在envoy上的服务间配置使用 HTTP/2 
来创建持久连接网格，这样请求和响应可以在此网格上进行多路复用。

**HTTP/3 支持（目前处于 alpha 版）：** 截至 1.19.0，Envoy 现在支持 HTTP/3 上游和下游，
并可以在任何方向翻译 HTTP/1.1、HTTP/2 和 HTTP/3 之间的组合。

**HTTP L7 路由：** 在 HTTP 模式下运行时，Envoy 支持一个 routing 子系统，
该子系统可以根据path, authority, content type, 运行时值等对请求进行路由和重定向。
该功能在将 Envoy 用作前端/边缘代理时最有用，但在构建服务网格时也能使用。

**gRPC 支持：** gRPC 是来自 Google 的 RPC 框架，使用 HTTP/2 或更高版本作为底层多路传输。
Envoy 支持使用 gRPC 请求和响应所需的所有 HTTP/2 功能。这两个系统非常互补。

**服务发现和动态配置：** Envoy 可以选择使用一组分层的动态配置 API 进行集中管理。 
这些层为 Envoy 提供了有关以下内容的动态更新： 后端集群中的主机， 后端集群本身、
HTTP 路由、侦听套接字和加密材料。 为了简化部署，后端主机发现可以通过 DNS 解析
（甚至完全跳过）来完成。 其他层被静态配置文件取代。

**健康检查：** 推荐的构建 Envoy 网格方式是将服务发现视为最终一致的过程。
Envoy 包含一个健康检查子系统，可以可选地对上游服务集群执行主动健康检查。
然后，Envoy 使用服务发现和健康检查信息的并集来确定健康的负载均衡目标。
Envoy 还通过异常值检测子系统支持被动健康检查。

**高级负载均衡：** 在分布式系统中不同组件之间的 load balancing 是一个复杂的问题。
因为 Envoy 是一个独立的代理而不是一个库，它能够在一个地方实现高级负载均衡技术，
并使它们对任何应用程序都可访问。目前 Envoy 支持自动重试、熔断、通过外部速率限制服务
进行全局速率限制、request shadowing 和异常值检测。计划将来支持请求 request racing。

**前端边缘代理支持：** 在边缘使用相同的软件具有很大优势（可观察性、管理、相同的服务发现和负载均衡算法等）。
Envoy有一套特性集，使其非常适合作为大多数现代Web应用程序用例的前端代理。
这包括TLS终止、HTTP/1.1 HTTP/2和HTTP/3支持，以及HTTP L7路由。

**一流的可观察性：**如上所述，Envoy的主要目标是使网络透明。然而，问题既发生在网络层面，也发生在应用层面。
Envoy为所有子系统提供了强大的统计支持。statsd（和兼容的提供者）是目前支持的统计接收器，
虽然插入不同的接收器并不困难。统计数据也可以通过管理端口查看。Envoy还支持通过第三方提供商进行分布式跟踪。

# 架构概述

## 介绍

### 术语定义

在我们深入了解主要架构文档之前，先给出一些定义。一些定义在业界略有争议，
但这是 Envoy 在整个文档和代码库中使用它们的方式，所以这就是生活。

- 主机 (Host)：能够进行网络通信的实体（手机上的应用程序、服务器等）。
在本文档中，主机是逻辑网络应用程序。一个物理硬件可以有多个主机在上面运行，只要它们中的每一个都可以被独立寻址。

- 下游 (Downstream)：下游主机连接到 Envoy，发送请求并接收响应。

- 上游 (Upstream)：上游主机接收来自 Envoy 的连接和请求，并返回响应。

- 侦听器 (Listener)：侦听器是一个命名的网络位置（例如，端口、UNIX 域套接字等），
  下游客户端可以连接到它。Envoy 暴露了一个或多个侦听器，下游主机连接到它。

- 集群 (Cluster)：集群是一组逻辑上相似的上游主机，Envoy 连接到这些主机。Envoy 通过 服务发现 发现集群成员。
  它还可以通过 主动健康检查 选择性地确定集群成员的健康状况。Envoy 将请求路由到的集群成员由 负载均衡策略 决定。
  
- 网格 (Mesh)：协调一致的网络拓扑的一组主机。在本文档中，“Envoy 网格”是指一组 Envoy 代理，
  它们构成一个消息传递基底，用于由许多不同服务和应用程序平台组成的分布式系统。

- 运行时配置：Envoy外部部署的运行时实时配置系统。可以改变配置设置，从而在不重新启动Envoy或更改主配置的情况下影响操作。


### 线程模型

Envoy 使用单进程多线程架构。

一个主线程控制各种零散的协调任务，而一定数量的 worker 线程执行监听、过滤和转发。

一旦连接被侦听器接受，连接将在其生命周期内绑定到单个 worker 线程。这允许 Envoy 的大部分代码
都是单线程的（可并行执行），并有一小部分更复杂的代码处理 worker 线程之间的协调。

通常，Envoy 被编写为 100% 非阻塞。

> **提示:**
>
> 对于大多数工作负载，我们建议将 worker 线程的数量配置为等于机器上硬件线程的数量。


#### 侦听器连接平衡

默认情况下，worker 线程之间没有协调。这意味着所有 worker 线程都独立地尝试在每个侦听器上接受连接，并依赖内核在线程之间进行适当的平衡。

对于大多数工作负载，内核在平衡传入连接方面做得非常出色。然而，对于一些工作负载，
特别是那些具有少量非常长连接的工作负载（例如，服务网格 HTTP2/gRPC 出口），
可能需要 Envoy 强制在 worker 线程之间平衡连接。
为了支持此行为，Envoy 允许在每个侦听器上配置不同类型的连接平衡。

> **注意:**
>
> 在 Windows 上，内核无法使用 Envoy 使用的异步 I/O 模型正确地平衡连接。

在平台修复此问题之前，Envoy 将强制执行 Windows 上的侦听器连接平衡。这允许我们在不同的 worker 线程之间平衡连接。这种行为会带来性能损失。

## 监听器

Envoy 配置支持单个进程中的任意数量的侦听器。通常，我们建议无论配置了多少侦听器，都只在一个机器上运行一个 Envoy。这使得操作更简单，并提供了一个统计信息的来源。

Envoy 支持 TCP 和 UDP 侦听器。

### TCP

每个监听器独立配置了filter_chains，根据filter_chain_match标准选择单个filter_chain。

单个filter_chain由一个或多个网络级别（L3/L4）过滤器组成。

当在监听器上接收到新连接时，选择适当的filter_chain，并实例化配置的连接本地过滤器堆栈并开始处理后续事件。

通用侦听器架构用于执行 Envoy 负责的大多数不同的代理任务（例如，限流、TLS 客户端认证、HTTP 连接管理、MongoDB 嗅探、原始 TCP 代理等）。

侦听器还可以选择性地配置一些侦听器过滤器。这些过滤器在网络级过滤器之前进行处理，并有机会操纵连接元数据，通常是为了影响连接如何被后面的过滤器或集群处理。

侦听器也可以通过侦听器发现服务 (LDS) 动态获取。

> **提示**
>
> 有关参考文档，请参见侦听器配置、protobuf 和组件部分。

### UDP

Envoy 除了支持 TCP 侦听器外，还支持 UDP 侦听器，并特别支持 UDP 侦听器过滤器。

UDP 侦听器过滤器在每个 worker 上实例化一次，并对该 worker 全局有效。

每个侦听器过滤器处理worker 在端口上监听时收到的每个 UDP 数据报。

实际上，UDP 侦听器使用 SO_REUSEPORT 内核选项进行配置，该选项将导致内核将每个 UDP 4 元组一致地哈希到同一个 worker 上。这允许 UDP 侦听器过滤器如果需要的话可以是“会话”导向的。此功能的一个内置示例是 UDP 代理侦听器过滤器。
