---
title: "使用 ebpf 获取 docker daemon 进程树"
date: 1970-01-01T12:00:00+08:00
draft: true
isCJKLanguage: true
Description: "如何使用 ebpf 获取 docker daemon 进程创建的所有进程信息"
Tags: ["docker", "go", "ebpf"]
Categories: ["ebpf"]
---

ebpf是一种在Linux内核中运行的程序，它可以高效地监控和修改网络和进程的行为。ebpf程序由两部分组成：内核空间程序和用户空间程序。内核空间程序负责捕获相关的事件并将它们传递给用户空间。用户空间程序负责处理内核空间程序传来的事件并进行进一步的分析或操作。

如果你想要用ebpf程序来获取docker容器内的进程信息，你需要做以下几个步骤：

- 编写一个内核空间程序，它可以利用ebpf的钩子（hooks）来监听容器中进程的创建、退出、执行等事件，并将这些事件以键值对（key-value）的形式存储在一个共享的数据结构中，比如哈希表（hash map）。
- 编写一个用户空间程序，它可以通过bpf系统调用（bpf syscall）来访问内核空间程序创建的数据结构，并从中读取容器中进程的信息，比如进程ID（pid）、命令行（cmdline）、环境变量（env）等。
- 使用clang或者其他工具来编译内核空间程序为一个二进制文件，比如prog.o，并将其加载到内核中。
- 运行用户空间程序，并根据需要输出或处理容器中进程的信息。

ebpf程序是实时获取进程信息的，因为它们会随着容器中进程的变化而更新数据结构中的内容。但是你也需要注意一些限制和挑战，比如：

- ebpf程序需要遵循一些规则和限制才能在内核中运行，比如不能有循环、不能访问任意地址、不能使用浮点数等。
- ebpf程序需要使用特定的语法和API来编写，比如C语言或者Go语言，并且需要引入一些头文件和库文件。
- ebpf程序需要考虑不同版本和配置下Linux内核对ebpf支持度和性能影响。